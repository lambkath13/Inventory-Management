@using Microsoft.Extensions.Localization
@inject IStringLocalizer<InventoryApp.Infrastructure.SharedResource> L

@{
  ViewData["Title"] = L["Create"];

  var stringCount = 3;
  var intCount    = 3;
  var boolCount   = 3;
  var textCount   = 3;
  var linkCount   = 3;
}

<h1 class="h4 mb-3">@L["Create"]</h1>

<form id="form">
  <div class="mb-3">
    <label class="form-label">@L["Title"]</label>
    <input class="form-control" name="title" required maxlength="200" />
  </div>

  <div class="mb-3">
    <label class="form-label">@L["Description"]</label>
    <textarea class="form-control" name="descriptionMarkdown" rows="4" maxlength="4000"></textarea>
  </div>

  <div class="mb-3">
    <label class="form-label">@L["Category"]</label>
    <input class="form-control" name="category" maxlength="100" />
  </div>

  <div class="mb-3">
    <label class="form-label">@L["Tags"]</label>
    <input class="form-control" name="tags" />
    <div class="form-text">@L["Example"] : laptop, asus, 2024</div>
  </div>

  <div class="form-check mb-3">
    <input class="form-check-input" type="checkbox" id="fPublic" name="isPublic" />
    <label class="form-check-label" for="fPublic">@L["Public"]</label>
  </div>

  <hr class="my-4" />
  <h2 class="h5 mb-3">@L["CustomFields"]</h2>

  <h3 class="h6">@L["StringFields"]</h3>
  @for (var i = 1; i <= stringCount; i++)
  {
    <div class="row g-2 mb-2">
      <div class="col-4 col-md-2">
        @await Html.PartialAsync("_FieldStateSelect", $"customString{i}State")
      </div>
      <div class="col">
        <input class="form-control"
               name="customString@iName"
               placeholder="FieldName" />
      </div>
    </div>
  }

  <h3 class="h6">@L["NumberFields"]</h3>
  @for (var i = 1; i <= intCount; i++)
  {
    <div class="row g-2 mb-2">
      <div class="col-4 col-md-2">
        @await Html.PartialAsync("_FieldStateSelect", $"customInt{i}State")
      </div>
      <div class="col">
        <input class="form-control"
               name="customInt@iName"
               placeholder="FieldName" />
      </div>
    </div>
  }

  <h3 class="h6">@L["BoolFields"]</h3>
  @for (var i = 1; i <= boolCount; i++)
  {
    <div class="row g-2 mb-2">
      <div class="col-4 col-md-2">
        @await Html.PartialAsync("_FieldStateSelect", $"customBool{i}State")
      </div>
      <div class="col">
        <input class="form-control"
               name="customBool@iName"
               placeholder="FieldName" />
      </div>
    </div>
  }

  <h3 class="h6">@L["TextFields"]</h3>
  @for (var i = 1; i <= textCount; i++)
  {
    <div class="row g-2 mb-2">
      <div class="col-4 col-md-2">
        @await Html.PartialAsync("_FieldStateSelect", $"customText{i}State")
      </div>
      <div class="col">
        <input class="form-control"
               name="customText@iName"
               placeholder="FieldName" />
      </div>
    </div>
  }

  <h3 class="h6">@L["LinkFields"]</h3>
  @for (var i = 1; i <= linkCount; i++)
  {
    <div class="row g-2 mb-2">
      <div class="col-4 col-md-2">
        @await Html.PartialAsync("_FieldStateSelect", $"customLink{i}State")
      </div>
      <div class="col">
        <input class="form-control"
               name="customLink@iName"
               placeholder="FieldName" />
      </div>
    </div>
  }

  <div class="form-text mb-3">@L["CustomFieldsHelp"]</div>

  <div class="d-flex gap-2">
    <button class="btn btn-primary" type="submit">@L["Save"]</button>
    <a class="btn btn-outline-secondary" href="/Inventories">@L["Back"]</a>
  </div>
</form>

@section Scripts{
<script>
document.getElementById('form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const f = e.currentTarget;

  const tags = (f.tags?.value || '')
    .split(',')
    .map(x => x.trim())
    .filter(x => x.length);

  const valOrNull  = input => input?.value?.trim() || null;
  const stateOrNum = sel   => Number(sel?.value ?? 0);

  const body = {
    title: f.title.value?.trim(),
    descriptionMarkdown: f.descriptionMarkdown.value?.trim(),
    category: f.category.value?.trim(),
    isPublic: f.isPublic.checked,
    tags
  };

  const kinds = ["String", "Int", "Bool", "Text", "Link"];
  const perKind = 3;

  for (const kind of kinds) {
    for (let i = 1; i <= perKind; i++) {
      const base = `custom${kind}${i}`;
      const stateName = base + "State";
      const nameName  = base + "Name";

      body[stateName] = stateOrNum(f[stateName]);
      body[nameName]  = valOrNull(f[nameName]);
    }
  }

  const r = await fetch('/api/inventories', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'same-origin',
    body: JSON.stringify(body)
  });

  if (r.status === 201) {
    const created = await r.json();
    location.href = '/Inventories/Details/' + created.id;
  } else if (r.status === 401) {
    alert('Unauthorized');
  } else {
    alert('@L["ErrorLoadingData"]');
  }
});
</script>
}
