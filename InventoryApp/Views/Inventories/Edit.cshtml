@using Microsoft.Extensions.Localization
@inject IStringLocalizer<InventoryApp.Infrastructure.SharedResource> L
@model int

@{
  ViewData["Title"] = L["Edit"];

  var stringCount = 3;
  var intCount    = 3;
  var boolCount   = 3;
  var textCount   = 3;
  var linkCount   = 3;
}

<h1 class="h4 mb-3">@L["Edit"]</h1>

<form id="form" class="d-none">
  <div class="mb-3">
    <label class="form-label">@L["Title"]</label>
    <input class="form-control" name="title" required maxlength="200" />
  </div>

  <div class="mb-3">
    <label class="form-label">@L["Description"]</label>
    <textarea class="form-control" name="descriptionMarkdown" rows="4" maxlength="4000"></textarea>
  </div>

  <div class="mb-3">
    <label class="form-label">@L["Category"]</label>
    <input class="form-control" name="category" maxlength="100" />
  </div>

  <div class="form-check mb-3">
    <input class="form-check-input" type="checkbox" id="fPublic" name="isPublic" />
    <label class="form-check-label" for="fPublic">@L["Public"]</label>
  </div>

  <div class="mb-3">
    <label class="form-label">@L["Tags"]</label>
    <div id="tagChips" class="mb-2"></div>
    <div class="input-group">
      <input id="tagInput" class="form-control" />
      <button class="btn btn-outline-secondary" type="button" id="btnAddTag">@L["Add"]</button>
    </div>
    <div class="form-text">@L["Example"] : laptop, asus, 2024</div>
  </div>

  <hr class="my-4" />
  <h5 class="mb-3">@L["CustomFields"]</h5>

  <div class="row">
    <div class="col-md-4">
      <h6 class="fw-bold mb-2">@L["StringFields"]</h6>

      @for (var i = 1; i <= stringCount; i++)
      {
        <div class="mb-2">
          <div class="row g-2">
            <div class="col-7">
              <input class="form-control"
                     name="customString@iName"
                     placeholder="String @i" />
            </div>
            <div class="col-5">
              @await Html.PartialAsync("_FieldStateSelect", $"customString{i}State")
            </div>
          </div>
        </div>
      }
    </div>

    <div class="col-md-4">
      <h6 class="fw-bold mb-2">@L["IntFields"]</h6>

      @for (var i = 1; i <= intCount; i++)
      {
        <div class="mb-2">
          <div class="row g-2">
            <div class="col-7">
              <input class="form-control"
                     name="customInt@iName"
                     placeholder="Int @i" />
            </div>
            <div class="col-5">
              @await Html.PartialAsync("_FieldStateSelect", $"customInt{i}State")
            </div>
          </div>
        </div>
      }

      <h6 class="fw-bold mb-2 mt-3">@L["BoolFields"]</h6>

      @for (var i = 1; i <= boolCount; i++)
      {
        <div class="mb-2">
          <div class="row g-2">
            <div class="col-7">
              <input class="form-control"
                     name="customBool@iName"
                     placeholder="Bool @i" />
            </div>
            <div class="col-5">
              @await Html.PartialAsync("_FieldStateSelect", $"customBool{i}State")
            </div>
          </div>
        </div>
      }
    </div>

    <div class="col-md-4">
      <h6 class="fw-bold mb-2">@L["TextFields"]</h6>

      @for (var i = 1; i <= textCount; i++)
      {
        <div class="mb-2">
          <div class="row g-2">
            <div class="col-7">
              <input class="form-control"
                     name="customText@iName"
                     placeholder="Text @i" />
            </div>
            <div class="col-5">
              @await Html.PartialAsync("_FieldStateSelect", $"customText{i}State")
            </div>
          </div>
        </div>
      }

      <h6 class="fw-bold mb-2 mt-3">@L["LinkFields"]</h6>

      @for (var i = 1; i <= linkCount; i++)
      {
        <div class="mb-2">
          <div class="row g-2">
            <div class="col-7">
              <input class="form-control"
                     name="customLink@iName"
                     placeholder="Link @i" />
            </div>
            <div class="col-5">
              @await Html.PartialAsync("_FieldStateSelect", $"customLink{i}State")
            </div>
          </div>
        </div>
      }
    </div>
  </div>

  <div class="d-flex gap-2 mt-3">
    <button class="btn btn-primary" type="submit">@L["Save"]</button>
    <a class="btn btn-outline-secondary" href="/Inventories/Details/@Model">@L["Back"]</a>
  </div>
</form>

<div id="loading" class="text-muted">@L["Loading"]</div>

@section Scripts{
<script>
(async function () {
  const id = @Model;
  const form = document.getElementById('form');
  const loading = document.getElementById('loading');

  const tagChips = document.getElementById('tagChips');
  const tagInput = document.getElementById('tagInput');
  const btnAddTag = document.getElementById('btnAddTag');

  const esc = s => (s ?? "").replace(/[&<>"]/g, m => (
    { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[m]
  ));

  const kinds = ["String", "Int", "Bool", "Text", "Link"];
  const perKind = 3;

  async function load() {
    const r = await fetch('/api/inventories/' + id, { credentials: 'same-origin' });
    if (!r.ok) { loading.textContent = '@L["ErrorLoadingData"]'; return; }
    const x = await r.json();

    form.title.value = x.title ?? '';
    form.descriptionMarkdown.value = x.descriptionMarkdown ?? '';
    form.category.value = x.category ?? '';
    form.isPublic.checked = !!x.isPublic;

    for (const kind of kinds) {
      for (let i = 1; i <= perKind; i++) {
        const base = `custom${kind}${i}`;
        const nameKey = base + "Name";
        const stateKey = base + "State";

        if (form[nameKey]) {
          form[nameKey].value = x[nameKey] ?? '';
        }
        if (form[stateKey]) {
          form[stateKey].value = x[stateKey] ?? 0;
        }
      }
    }

    await loadTags();
    loading.classList.add('d-none');
    form.classList.remove('d-none');
  }

  async function loadTags() {
    try {
      const r = await fetch(`/api/inventories/${id}/tags`, { credentials: 'same-origin' });
      if (!r.ok) {
        tagChips.innerHTML = '<span class="text-muted">@L["Empty"]</span>';
        return;
      }
      const tags = await r.json();
      const list = Array.isArray(tags) ? tags.map(t => t.name ?? t.Name ?? '') : [];
      renderChips(list);
    } catch {
      tagChips.innerHTML = '<span class="text-muted">@L["Empty"]</span>';
    }
  }

  function renderChips(list) {
    if (!list.length) {
      tagChips.innerHTML = '<span class="text-muted">@L["Empty"]</span>';
      return;
    }
    tagChips.innerHTML = list.map(name => `
      <span class="badge text-bg-secondary me-2">
        ${esc(name)}
        <button type="button" class="btn btn-sm btn-light ms-1" data-remove="${esc(name)}">Ã—</button>
      </span>
    `).join('');
  }

  tagChips.addEventListener('click', async (e) => {
    const name = e.target?.getAttribute?.('data-remove');
    if (!name) return;
    const r = await fetch(`/api/inventories/${id}/tags?tag=${encodeURIComponent(name)}`, {
      method: 'DELETE',
      credentials: 'same-origin'
    });
    if (r.status === 204) {
      await loadTags();
    } else {
      alert('@L["ErrorLoadingData"]');
    }
  });

  btnAddTag.addEventListener('click', async () => {
    const name = (tagInput.value || '').trim();
    if (!name) return;
    const r = await fetch(`/api/inventories/${id}/tags?tag=${encodeURIComponent(name)}`, {
      method: 'POST',
      credentials: 'same-origin'
    });
    if (r.ok) {
      tagInput.value = '';
      await loadTags();
    } else {
      alert('@L["ErrorLoadingData"]');
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const body = {
      title: form.title.value?.trim(),
      descriptionMarkdown: form.descriptionMarkdown.value?.trim(),
      category: form.category.value?.trim(),
      isPublic: form.isPublic.checked
    };

    for (const kind of kinds) {
      for (let i = 1; i <= perKind; i++) {
        const base = `custom${kind}${i}`;
        const nameKey = base + "Name";
        const stateKey = base + "State";

        if (form[nameKey]) {
          body[nameKey] = form[nameKey].value?.trim();
        }
        if (form[stateKey]) {
          body[stateKey] = Number(form[stateKey].value || 0);
        }
      }
    }

    const r = await fetch('/api/inventories/' + id, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify(body)
    });

    if (r.ok) {
      location.href = '/Inventories/Details/' + id;
    } else if (r.status === 403) {
      alert('Forbidden');
    } else if (r.status === 412) {
      alert('Version mismatch');
    } else {
      alert('@L["ErrorLoadingData"]');
    }
  });

  await load();
})();
</script>
}
